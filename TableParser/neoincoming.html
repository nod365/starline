<!DOCTYPE html>
<html lang="ru">

<head>
    <title>TB Call Tracking</title>
    <meta charset="UTF-8" />
    <meta name="theme-color" content="#EEE" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="./icons/favicon.ico" sizes="any"><!-- 32√ó32 -->
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png"><!-- 180√ó180 -->
    <link rel="manifest" href="./manifest.webmanifest">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <script src="./script/dom-to-image.min.js"></script>
    <script src="./script/darkside.js"></script>
    <script src="./script/squircle.js"></script>
    <script src="./script/pie.js"></script>
    <script src="./script/vaporwave.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="./css/tableparser.css?2601071450">

    <script>
        const build = 2601081530
    </script>

    <style>
        tr td:first-child {
            border-radius: 30px 0 0 30px !important;
        }

        tr:nth-child(even):not(.red).subBlockRow td {
            background-color: #0096061c;
        }

        tr:not(.red).subBlockRow td,
        tr:not(.red).subBlockRow td .opacitytext {
            color: #009606;
        }

        th.GR {
            background: linear-gradient(90deg, rgba(235, 237, 255, 1) 70%, #d1e5d2 100%);
            padding-right: 50px;
        }

        th.color1 {
            background: #4CAF50;
        }

        th.color2 {
            background: #439846;
        }

        th.color0 {
            background: #358138;
        }

        svg.chart {
            margin: auto;
            display: block;
        }

        .elCopyright:before {
            content: 'Table Parser Call Tracking';
        }
    </style>


</head>

<body>
    <wrap class="dark">
        <leftmenu>
            <div>
                <a href="./index.html">
                    <div>
                        <div class="leftButton">
                            <emoji>ü•≠</emoji>Mango Office <b>Table Parser 4</b>
                        </div>
                    </div>
                </a>
                <a href="./performance.html">
                    <div>
                        <div class="leftButton">
                            <emoji>üìà</emoji>Call Center <b>Performance 2</b>
                        </div>
                    </div>
                </a>
                <div class="leftButton Logo buttonLogoSelected">
                    <emoji>‚û°Ô∏è</emoji>Table Parser <b>Call Tracking</b>
                </div>
                <!--<a href="./recall.html">
					<div>
						<div class="leftButton">
							<emoji>‚òéÔ∏è</emoji>Response <b>Time Analytics</b>
						</div>
					</div>
				</a>-->
                <div class="leftButton" id="themeToggleBtn">
                    <emoji>üåö</emoji>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞
                </div>
                <a target="_blank" href="https://github.com/nod365/starline">
                    <div>
                        <div class="leftButton">
                            <emoji>üç¥</emoji>Fork me on GitHub
                        </div>
                    </div>
                </a>
                <div>
                    <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1>
                    <div class="app-hr"></div>
                </div>
                <div class="leftButton" id="opencsv">
                    <emoji>üìÑ</emoji>–û—Ç–∫—Ä—ã—Ç—å CSV-—Ñ–∞–π–ª
                </div>
                <div class="leftButton" id="gethelp">
                    <emoji>üìö</emoji>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
                </div>
            </div>
            <div class="flexible" id="editable">
                <!--
				<div><h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h1><div class="app-hr"></div></div>
				<div class="leftButton"><emoji>üëç</emoji>–ö–Ω–æ–ø–∫–∞ 1</div>
				-->
            </div>
            <div>
                <div class="app-hr"></div>
                <div id="infoplace"></div>
                <div id="updatesinfo">
                    <div class="leftButton Logo">
                        <emoji class="rotating">‚è≥</emoji>–ü—Ä–æ–≤–µ—Ä—è—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...
                    </div>
                </div>
            </div>
        </leftmenu>
        <container>
            <output>
                <div class="parent" id="startpageAnime">
                    <div class="parent dimmer">
                        <div class="child" id="startpage">
                            <div class="container">
                                <h1>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä CSV –¥–ª—è Call-Center –≥—Ä—É–ø–ø (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)</h1>

                                <div class="upload-section">
                                    <input type="file" id="csvFile" accept=".csv">
                                    <button onclick="loadCSV()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å CSV</button>
                                    <p class="small">–ö–æ–¥–∏—Ä–æ–≤–∫–∞: Windows-1251 (–µ—Å–ª–∏ CSV –≤ –¥—Ä—É–≥–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–µ ‚Äî –∑–∞—Ä–∞–Ω–µ–µ
                                        –ø–µ—Ä–µ–∫–æ–¥–∏—Ä—É–π—Ç–µ)</p>
                                </div>

                                <div id="dateRange" class="date-range"></div>

                                <div id="tableContainer"></div>

                                <div class="info">
                                    <p><strong>–¶–µ–ª–µ–≤—ã–µ –≥—Ä—É–ø–ø—ã:</strong> Call - Center, Call - Center [–î–¢–ü], Call -
                                        Center [–ü–æ–ª–æ–º–∫–∏], Call -
                                        Center [–ì–ò–ë–î–î], –ö–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê</p>
                                    <p class="small">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî —Ç–µ, –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤
                                        –∫–æ–ª–æ–Ω–∫–µ "–î–∞—Ç–∞" —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å
                                        –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã (—ç—Ç–æ –≤–∞—à–∞ "–∏—Ç–æ–≥–æ–≤–∞—è" —Å—Ç—Ä–æ–∫–∞).</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </output>
        </container>
    </wrap>
    <render style="display:none;">
    </render>
    <files style="display: none;">
        <input type="file" id="files" accept=".csv">
    </files>

    <script>
        let daterangetable = '';
        function createChartObject() {
            let data = [];

            const handler = {
                get(target, prop) {
                    if (prop === 'add' || prop === '+=') {
                        return function (item) {
                            data.push(item);
                            return proxy;
                        };
                    }
                    if (prop === 'data') return data;
                    if (prop === 'toObject') return () => ({ data: [...data] });
                    return target[prop];
                }
            };

            const proxy = new Proxy({}, handler);
            return proxy;
        }

        let chartObj = createChartObject();

        const targetGroups = [
            "Call - Center",
            "Call - Center [–î–¢–ü]",
            "Call - Center [–ü–æ–ª–æ–º–∫–∏]",
            "Call - Center [–ì–ò–ë–î–î]",
            "–ö–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê"
        ];

        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª');
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                const contents = e.target.result;
                processCSV(contents);
            };

            reader.readAsText(file, 'Windows-1251');
        }

        function processCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const row = parseCSVLine(line);
                    data.push(row);
                }
            }

            if (data.length < 2) {
                alert('CSV —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');
                return;
            }

            const headers = data[0].map(h => h.replace(/"/g, '').trim());
            const groupIndex = headers.indexOf('–ì—Ä—É–ø–ø–∞');
            const dateIndex = headers.indexOf('–î–∞—Ç–∞');
            const acceptedIndex = headers.indexOf('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω—è—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤');
            const completedIndex = headers.indexOf('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤');
            const missedIndex = headers.indexOf('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤');

            if (groupIndex === -1 || dateIndex === -1) {
                alert('CSV —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–ì—Ä—É–ø–ø–∞, –î–∞—Ç–∞)');
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ (–≥–¥–µ –ì—Ä—É–ø–ø–∞ === –î–∞—Ç–∞)
            const finalRows = [];
            const allDates = [];

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length <= Math.max(groupIndex, dateIndex)) continue;
                const group = (row[groupIndex] || '').replace(/"/g, '').trim();
                const date = (row[dateIndex] || '').replace(/"/g, '').trim();

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                if (group && /^\d{2}\.\d{2}\.\d{4}$/.test(date)) {
                    allDates.push(date);
                }

                // –¢–û–õ–¨–ö–û —Å—Ç—Ä–æ–∫–∏ –≥–¥–µ –ì—Ä—É–ø–ø–∞ === –î–∞—Ç–∞
                if (group && date && group === date) {
                    const accepted = acceptedIndex !== -1 ? parseInt((row[acceptedIndex] || '0').replace(/"/g, '')) || 0 : 0;
                    const completed = completedIndex !== -1 ? parseInt((row[completedIndex] || '0').replace(/"/g, '')) || 0 : 0;
                    const missed = missedIndex !== -1 ? parseInt((row[missedIndex] || '0').replace(/"/g, '')) || 0 : 0;
                    finalRows.push({ group, accepted, completed, missed });
                }
            }

            // –ù–∞—Ö–æ–¥–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
            let minDate = null, maxDate = null;
            if (allDates.length > 0) {
                const dateObjects = allDates.map(dateStr => {
                    const [d, m, y] = dateStr.split('.');
                    return new Date(y, m - 1, d);
                });
                minDate = new Date(Math.min(...dateObjects));
                maxDate = new Date(Math.max(...dateObjects));
            }


            //const dateRangeElement = document.getElementById('dateRange');
            if (minDate && maxDate) {
                const formatDate = d => `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
                daterangetable = `–ü–µ—Ä–∏–æ–¥ ${formatDate(minDate)} - ${formatDate(maxDate)}`;
            } else {
                daterangetable = '–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
            }

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ–ª–µ–≤—ã–º –≥—Ä—É–ø–ø–∞–º –¢–û–õ–¨–ö–û –∏–∑ –∏—Ç–æ–≥–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
            const groupData = {};
            for (const t of targetGroups) groupData[t] = { accepted: 0, completed: 0, missed: 0 };

            // –ü—Ä–æ—á–∏–µ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–µ —Ü–µ–ª–µ–≤—ã–µ)
            const others = [];

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ (–≥–¥–µ group === date)
            for (const row of finalRows) {
                if (targetGroups.includes(row.group)) {
                    groupData[row.group] = {
                        accepted: row.accepted,
                        completed: row.completed,
                        missed: row.missed
                    };
                } else {
                    others.push(row);
                }
            }

            // –û–±—â–∏–µ –∏—Ç–æ–≥–∏
            let totalAccepted = 0, totalCompleted = 0, totalMissed = 0;
            for (const g of Object.keys(groupData)) {
                totalAccepted += groupData[g].accepted;
                totalCompleted += groupData[g].completed;
                totalMissed += groupData[g].missed;
            }

            // –°–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è Call - Center
            const callCenterName = 'Call - Center';
            const callCenter = groupData[callCenterName] || { accepted: 0, completed: 0, missed: 0 };

            // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π Call-Center
            const reports = { accepted: 0, completed: 0, missed: 0 };
            const dispatchers = { accepted: 0, completed: 0, missed: 0 };
            const othersForCall = { accepted: 0, completed: 0, missed: 0 };

            // –û—Ç–¥–µ–ª—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–°–æ–µ–¥–∏–Ω–µ–Ω—ã —Å –¥—Ä—É–≥–∏–º–∏"
            const otherDepartments = ['–æ—Ñ–æ—Ä–º–ª', '—Å–µ—Ä–≤–∏—Å', '–∞–¥–º–∏–Ω', '–æ–±–ª'];

            // –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ others, –∫–æ—Ç–æ—Ä—ã–µ:
            // 1. –Ø–≤–ª—è—é—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–º–∏ (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—ã—à–µ)
            // 2. –ù–µ –≤—Ö–æ–¥—è—Ç –≤ targetGroups (—É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ)
            for (const row of others) {
                const nameLower = row.group.toLowerCase();

                if (nameLower.includes('–æ—Ç—á–µ—Ç')) {
                    reports.accepted += row.accepted;
                    reports.completed += row.completed;
                    reports.missed += row.missed;
                } else if (nameLower.includes('–¥–∏—Å–ø–µ—Ç—á')) {
                    dispatchers.accepted += row.accepted;
                    dispatchers.completed += row.completed;
                    dispatchers.missed += row.missed;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–¥–∏–Ω –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–≤
                    let isOtherDepartment = false;
                    for (const dept of otherDepartments) {
                        if (nameLower.includes(dept)) {
                            isOtherDepartment = true;
                            break;
                        }
                    }

                    if (isOtherDepartment) {
                        othersForCall.accepted += row.accepted;
                        othersForCall.completed += row.completed;
                        othersForCall.missed += row.missed;
                    }
                    // –ï—Å–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –Ω–∏ –æ—Ç—á–µ—Ç–æ–º, –Ω–∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º, –Ω–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–º –æ—Ç–¥–µ–ª–æ–º - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                }
            }

            // '–†–µ—à–∏–ª–∏ —Å–∞–º–∏' = —Ç–æ, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –≤ Call - Center –ø–æ—Å–ª–µ –≤—ã—á–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–≥—Ä—É–ø–ø
            const resolvedBySelf = {
                accepted: Math.max(0, callCenter.accepted - (reports.accepted + dispatchers.accepted + othersForCall.accepted)),
                completed: Math.max(0, callCenter.completed - (reports.completed + dispatchers.completed + othersForCall.completed)),
                missed: Math.max(0, callCenter.missed - (reports.missed + dispatchers.missed + othersForCall.missed))
            };

            // –ì–æ—Ç–æ–≤–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const displayOrder = [];
            if (groupData[callCenterName]) displayOrder.push({ name: callCenterName, data: groupData[callCenterName] });

            // –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ Call-Center
            const callSub = [
                { name: '–ù–∞ –æ—Ç—á–µ—Ç–Ω–∏–∫–æ–≤', data: reports },
                { name: '–ù–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–≤', data: dispatchers },
                { name: '–ù–∞ –¥—Ä—É–≥–∏—Ö', data: othersForCall },
                { name: '–†–µ—à–∏–ª–∏ —Å–∞–º–∏', data: resolvedBySelf }
            ];

            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ü–µ–ª–µ–≤—ã–µ –≥—Ä—É–ø–ø—ã
            for (const t of targetGroups) {
                if (t === callCenterName) continue;
                if (groupData[t]) displayOrder.push({ name: t, data: groupData[t] });
            }

            // –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É
            createTable({ displayOrder, callSub, totals: { totalAccepted, totalCompleted, totalMissed } });
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result;
        }

        function createTable({ displayOrder, callSub, totals }) {
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = '';

            const table = document.createElement('table');

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            const header = document.createElement('tr');
            header.classList.add('squircle');
            header.innerHTML = `<th colspan="1" class="left GR"><div class="desIcon parkid"></div><span class="thName">–ü—Ä–∏—á–∏–Ω—ã –∑–≤–æ–Ω–∫–æ–≤</span><br><span class="dateHeader opacitytext minitext"> ${daterangetable} </span></th>
                                <th colspan="2" class="minitext color1"><div class="callIcon"></div><br>–ü—Ä–∏–Ω—è—Ç—ã–µ</th>
                                <th colspan="2" class="minitext color2"><div class="callIcon"></div><br>–ò—Å—Ö–æ–¥—è—â–∏–µ</th>
                                <th colspan="2" class="minitext color0"><div class="callIcon"></div><br>–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ</th>
                                `;
            table.appendChild(header);

            table.innerHTML += '<tr class="ultraborder"><td></td></tr><tr class="ultraborder"><td></td></tr>'

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –æ—Ç –æ–±—â–µ–≥–æ (totals) ‚Äî –¥–ª—è —Å—Ç—Ä–æ–∫ –∫—Ä–æ–º–µ Call - Center –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const totalAccepted = totals.totalAccepted;
            const totalCompleted = totals.totalCompleted;
            const totalMissed = totals.totalMissed;

            for (const item of displayOrder) {
                const row = document.createElement('tr');
                const acceptedPercent = totalAccepted > 0 ? ((item.data.accepted / totalAccepted) * 100).toFixed(1) : '0.0';
                const completedPercent = totalCompleted > 0 ? ((item.data.completed / totalCompleted) * 100).toFixed(1) : '0.0';
                const missedPercent = totalMissed > 0 ? ((item.data.missed / totalMissed) * 100).toFixed(1) : '0.0';

                item.name = item.name.replaceAll('Call - Center [', '–õ–∏–Ω–∏—è ').replaceAll(']', '').replaceAll('–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê', '–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞')

                row.innerHTML = `
					<td class="left">${item.name}</td>
					
                    <td class="noPaddingRight right">${item.data.accepted} </td>
                    <td class="noPaddingLeft left">
                        <div class="minitext opacitytext">
                            / ${acceptedPercent}%
                        </div>
                    </td>
					
                    <td class="noPaddingRight right">${item.data.completed} </td>
                    <td class="noPaddingLeft left">
                        <div class="minitext opacitytext">
                            / ${completedPercent}%
                        </div>
                    </td>
					
                    <td class="noPaddingRight right">${item.data.missed} </td>
                    <td class="noPaddingLeft left">
                        <div class="minitext opacitytext">
                            / ${missedPercent}%
                        </div>
                    </td>
				`;
                table.appendChild(row);

                // –ï—Å–ª–∏ —ç—Ç–æ Call - Center ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä—è–º–æ –ø–æ–¥ –Ω–µ–π
                if (item.name === 'Call - Center') {
                    const callAcceptedBase = item.data.accepted || 0;
                    const callCompletedBase = item.data.completed || 0;
                    const callMissedBase = item.data.missed || 0;




                    // –í—Å—Ç–∞–≤–∏–º —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

                    for (const [index, sub] of callSub.entries()) {
                        const isLast = index === callSub.length - 1;
                        const treeSymbol = isLast ? '‚îî' : '‚îú';
                        const treeSymbolReverse = isLast ? '‚îò' : '‚î§';

                        const a = sub.data.accepted || 0;
                        const c = sub.data.completed || 0;
                        const m = sub.data.missed || 0;

                        const aPct = callAcceptedBase > 0 ? ((a / callAcceptedBase) * 100).toFixed(1) : '0.0';
                        const cPct = callCompletedBase > 0 ? ((c / callCompletedBase) * 100).toFixed(1) : '0.0';
                        const mPct = callMissedBase > 0 ? ((m / callMissedBase) * 100).toFixed(1) : '0.0';

                        const subBlockRow = document.createElement('tr');
                        subBlockRow.classList.add('subBlockRow')
                        chartObj.add({ label: sub.name.replaceAll('–†–µ—à–∏–ª–∏ —Å–∞–º–∏','–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã'), value: a })
                        subBlockRow.innerHTML = `
                            <td class="left">${treeSymbol}‚îÄ ${sub.name}</td>
                            <td class="noPaddingRight right">${a} ${treeSymbolReverse}</td>
                            <td colspan="5" class="noPaddingLeft left">
                                <div class="minitext opacitytext">¬† ${treeSymbol} ${aPct}%</div>
                            </td>
                        `;

                        table.appendChild(subBlockRow);
                    }

                } else {
                    chartObj.add({ label: item.name, value: item.data.accepted })
                }
            }

            // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
				<td class="left"><strong>–ò—Ç–æ–≥–æ</strong></td>
				<td colspan="2"><strong>${totalAccepted}</strong></td>
				<td colspan="2"><strong>${totalCompleted}</strong></td>
				<td colspan="2"><strong>${totalMissed}</strong></td>
			`;
            table.appendChild(totalRow);
            table.innerHTML += `
                <tr class="tableCopyrightInfo"><td style="background: transparent" colspan="7">
                <div class="minitext newFlex">
                <div class="elCopyright"> </div>
                <div> build ${build} </div>
                </div>
                </td></tr>                    
            `

            let localHTML = '';

            const pieConfig = {
                data: chartObj.data,
                title: "–î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–∏—á–∏–Ω –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤",
                donut: true
            };


            localHTML += '<div class="tableWrap oneInListing">'
            localHTML += '<div class="intableFlex">'
            localHTML += '<div>' + daterangetable + '</div>'
            localHTML += '<div class="intableButton printbutton" data-id="id0"><emoji>üñ®Ô∏è</emoji>–ü–µ—á–∞—Ç–∞—Ç—å</div>'
            localHTML += '<div class="intableButton blinkOnce copybutton" data-id="id0"><emoji>üìã</emoji>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>'
            localHTML += '</div>'
            localHTML += '<div class="tableOutput" id="id0">'
            localHTML += table.outerHTML
            localHTML += pieChart(pieConfig);
            localHTML += '</div>'
            localHTML += '</div></div>'


            document.getElementsByTagName('output')[0].innerHTML = ''
            document.getElementsByTagName('output')[0].insertAdjacentHTML('beforeend', localHTML);
            applyClipPathToSquarcles();

            document.querySelectorAll('.printbutton').forEach(button => {
                button.addEventListener('click', function () {
                    let id = this.getAttribute('data-id'); // –ü–æ–ª—É—á–∞–µ–º id –∏–∑ data-id
                    PrintImage(id, this);
                });
            });

            //tableContainer.appendChild(table);
        }

        function toLocalISOString(date = new Date()) {
            const tzOffset = -date.getTimezoneOffset();
            const sign = tzOffset >= 0 ? '+' : '-';
            const hours = String(Math.floor(Math.abs(tzOffset) / 60)).padStart(2, '0');
            const minutes = String(Math.abs(tzOffset) % 60).padStart(2, '0');

            return (
                new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, -1) +
                `${sign}${hours}:${minutes}`
            );
        }


        function PrintImage(tableID, button) {
            console.log(tableID)
            const source = document.querySelector('#' + tableID);

            if (!source) return;

            const html = `
				<!DOCTYPE html>
				<html lang="ru">
				<head>
				<meta charset="UTF-8">
				<meta http-equiv="X-UA-Compatible" content="IE=edge">
				<meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="stylesheet" href="https://nod365.github.io/starline/TableParser/css/tableparser.css?${build}">

				<title>Print</title>

				<style>
                    .squircle {
    clip-path: unset !important;
}
    
				@page {
				size: A4;
				margin: 0;
				}

				body {
				background: #444;
				margin: 0;
				padding: 0;
				}

				.page {
				background: #FFF;
				width: 210mm;
				height: 297mm;
				padding: 5mm;
				box-sizing: border-box;
				margin: auto;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
				}
                
                .minitext { font-size: 15px; }
                .opacitytext { opacity: 1; }
                .tableCopyrightInfo { opacity: .5; }
                th.GR { border-radius: 30px 0 0 30px; }
                th.color0 { border-radius: 0 30px 30px 0; }
                th {box-shadow: none !important}
                .elCopyright:before {    content: '${CryptoJS.MD5(source.innerHTML).toString()} at ${toLocalISOString()}'; }
                
                tr td:first-child { border-radius: 30px 0 0 30px !important;}
                tr:nth-child(even):not(.red).subBlockRow td {background-color: #0096061c;}
                tr:not(.red).subBlockRow td, tr:not(.red).subBlockRow td .opacitytext { color: #009606; }
                th.GR { background: linear-gradient(90deg, rgba(235, 237, 255, 1) 70%, #d1e5d2 100%); padding-right: 50px; }
                th.color1 { background: #4CAF50; border-radius: 30px 0 0 30px; box-shadow: 0 0 0px 15px #d1e5d2 !important; }
                th.color2 { background: #439846; }
                th.color0 { background: #358138; }
                svg.chart { margin: auto; display: block; }

				</style>
				</head>

				<body>
				<div class="page">
                    <div class="print-content">
					    ${source.innerHTML}
	    			</div>
				</div>
                
				</body>
               
				</html>
				`;

            const js = `
                (function () {
                    function fitTableToPage() {
    const page = document.querySelector('.page');
    const content = document.querySelector('.print-content');
    if (!page || !content) return;

    const pageRect = page.getBoundingClientRect();
    const contentRect = content.getBoundingClientRect();

    const style = window.getComputedStyle(page);

    const paddingX =
        parseFloat(style.paddingLeft) +
        parseFloat(style.paddingRight);

    const paddingY =
        parseFloat(style.paddingTop) +
        parseFloat(style.paddingBottom);

    const availableWidth = pageRect.width - paddingX;
    const availableHeight = pageRect.height - paddingY;

    const scaleX = availableWidth / contentRect.width;
    const scaleY = availableHeight / contentRect.height;

    const scale = Math.min(scaleX, scaleY, 1);

    content.style.transformOrigin = 'center';
    content.style.transform = 'scale(' + scale + ')';
}

                    window.addEventListener('load', function () {
                        requestAnimationFrame(function () {
                            requestAnimationFrame(function () {
                                setTimeout(fitTableToPage, 0);
                            });
                        });
                    });
                })();
            `;

            const win = window.open('', '_blank');
            win.document.open();
            win.document.write(html);
            win.eval(js);
            win.document.close();
        }

    </script>


</body>

</html>
<!-- 
CHANGELOG

-->
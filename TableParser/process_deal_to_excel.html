<!doctype html>
<html lang="ru">

<head>

  <title>–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</title>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#EEE" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/tableparser.css">
  <script src="./script/darkside.js"></script>

  <link rel="icon" href="./icons/favicon.ico" sizes="any"><!-- 32√ó32 -->
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png"><!-- 180√ó180 -->
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- CDN –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.js"></script>

  <style>
    :root {
      --bg: #f6f8fa;
      --card: #fff;
      --accent: #4CAF50;
      --muted: #666;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
    }

    h1 {
      margin: 0 0 16px 0;
      font-size: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(20, 20, 20, 0.06);
      margin-bottom: 16px;
    }

    .dark .card {
      background: #222;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .row-col {
      flex: 1;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px 0;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .dark input[type="text"],
    .dark input[type="date"],
    .dark select {
      background: #333;
      border: 1px solid #444;
    }

    input[type="file"] {
      font-size: 14px;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    button.secondary {
      background: #1976d2;
    }

    .log {
      height: 240px;
      font-family: monospace;
      overflow: auto;
      white-space: pre-wrap;
      background: #111;
      color: #e8f5e9;
      padding: 10px;
      border-radius: 8px;
    }

    .small {
      font-size: 13px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .footer-note {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    @media (max-width:640px) {
      .row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <wrap class="dark">
    <leftmenu>
      <div>
        <a href="./index.html">
          <div>
            <div class="leftButton">
              <emoji>ü•≠</emoji>Mango Office <b>Table Parser 4</b>
            </div>
          </div>
        </a>
        <a href="./performance.html">
          <div>
            <div class="leftButton">
              <emoji>üìà</emoji>Call Center <b>Performance 2</b>
            </div>
          </div>
        </a>
        <div class="leftButton Logo buttonLogoSelected">
          <emoji>üìä</emoji>–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
        </div>
        <!--<a href="./recall.html">
					<div>
						<div class="leftButton">
							<emoji>‚òéÔ∏è</emoji>Response <b>Time Analytics</b>
						</div>
					</div>
				</a>-->
        <div class="leftButton" id="themeToggleBtn">
          <emoji>üåö</emoji>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞
        </div>
        <a target="_blank" href="https://github.com/nod365/starline">
          <div>
            <div class="leftButton">
              <emoji>üç¥</emoji>Fork me on GitHub
            </div>
          </div>
        </a>
        <div>
          <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1>
          <div class="app-hr"></div>
        </div>
        <div class="leftButton" id="opencsv">
          <emoji>üìÑ</emoji>–û—Ç–∫—Ä—ã—Ç—å CSV-—Ñ–∞–π–ª
        </div>
        <div class="leftButton" id="gethelp">
          <emoji>üìö</emoji>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
        </div>
      </div>
      <div class="flexible" id="editable">
        <div>
          <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
          <div class="app-hr"></div>
        </div>
        <div class="leftButton buttonSelected">
          <emoji>üë©üèª‚Äçüíª</emoji>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–∞–±–ª–∏—Ü
        </div>
        <!--
				<div><h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h1><div class="app-hr"></div></div>
				<div class="leftButton"><emoji>üëç</emoji>–ö–Ω–æ–ø–∫–∞ 1</div>
				-->
      </div>
      <div>
        <div class="app-hr"></div>
        <div id="infoplace"></div>
        <div id="updatesinfo">
          <div class="leftButton Logo">
            <emoji class="rotating">‚è≥</emoji>–ü—Ä–æ–≤–µ—Ä—è—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...
          </div>
        </div>
      </div>
    </leftmenu>
    <container>
      <div class="container">
        <h1>–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</h1>

        <div class="card">
          <label>CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–¥–µ–ª–æ–∫ (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å `;`):</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <div class="small">–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É "–ò—Å—Ç–æ—á–Ω–∏–∫" –∏ –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–∞–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ "–¥–∞—Ç–∞" –∏–ª–∏
            "date").</div>
        </div>

        <div class="card">
          <label>Excel —à–∞–±–ª–æ–Ω (–ö–¶ –ê–≤–µ–Ω—é.xlsx):</label>
          <input id="templateFile" type="file"
            accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <div class="small">–®–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ª–∏—Å—Ç—ã: —Ç–µ –∂–µ, —á—Ç–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ).</div>
        </div>

        <div class="card">
          <div class="flex-between">
            <div style="flex:1; margin-right:12px;">
              <label>–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª (–∏–º—è):</label>
              <input id="outputName" type="text" value="–ö–¶ –ê–≤–µ–Ω—é_–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.xlsx" />
            </div>
            <div>
              <label>–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:</label>
              <div class="row">
                <input id="startDate" type="date" />
                <input id="endDate" type="date" />
              </div>
              <div class="controls" style="margin-top:8px;">
                <button id="currentMonth">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
                <button id="setDefaults" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞—Ç—ã</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <button id="processBtn" style="font-size:16px; padding:12px 18px;">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div class="small">–†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –∫–∞–∫ .xlsx.</div>
          </div>
        </div>

        <div class="card">
          <label>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
          <div id="log" class="log"></div>
          <div class="footer-note">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è—Ö.</div>
        </div>
      </div>
    </container>
  </wrap>

  <script>
    dayjs.extend(dayjs_plugin_customParseFormat);

    /* –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ Python) */
    const SHEET_CFG = {
      '–ê–≤–∏—Ç–æ': ["Easy Park (–°–æ–∫–æ–ª)", "Mospark Two (–ú–æ–∂–∞–π–∫–∞)", "–ú–ê–ì–ò–Ø", "–ú–Å–î", "–ë–æ—Ä—Ç ‚Ññ1", "–ß–ê–†–¢–ï–†", "–ú–û–°–§–ò–õ–¨–ú–ü–ê–†–ö"],
      '–Ø–≥–∞—Ä–∞–∂': ["–Ø–Ω–¥–µ–∫—Å.–ì–∞—Ä–∞–∂", "ChatApp - WhatsApp (external provider) - –Ø–Ω–¥–µ–∫—Å.–ì–∞—Ä–∞–∂"],
      '–°–∞–π—Ç': ["–°–∞–π—Ç"],
      '–ü—Ä–æ—á–∏–π —Ç—Ä–∞—Ñ–∏–∫': [] // –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    };

    const BAD_LEADS_REASONS = ["–î–£–ë–õ–¨", "–ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é", "–î–µ–π—Å—Ç–≤—É—é—â–∏–π –≤–æ–¥–∏—Ç–µ–ª—å",
      "–°–ø–∞–º", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä", "–¢–ï–°–¢", "–î–£–ë–õ–¨! –ë–û–†–¢‚Ññ1/–ß–ê–†–¢–ï–† –ü–ï–†–ï–î–ê–õ–ò –ó–ê–ò–†–£!"];

    const STAGE_MAPPING = {
      '–ë–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏': 'D',
      '–ß–∞—Ç—ã –ê–≤–∏—Ç–æ': 'E',
      '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è': 'F',
      '–ü—Ä–æ–≤–µ—Ä–∫–∞ –°–ë': 'G',
      '–î–æ–∂–∏–º': 'H',
      '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ': 'I',
      '–ü—Ä–∏–µ—Ö–∞–ª –≤ —Ç–∫—Å–æ–ø–∞—Ä–∫': 'J',
      '–°–¥–µ–ª–∫–∞ –Ω–µ —Å–æ—Å—Ç–æ—è–ª–∞—Å—å': 'K',
      '–ë–∏–∑–Ω–µ—Å –∫–ª–∞—Å—Å': 'L',
      '–í—ã–∫—É–ø': 'M',
      '–ê–≤—Ç–æ –ø–æ–¥ –¥–æ—Å—Ç–∞–≤–∫—É': 'N',
      '–í –ø–∞—Ä–∫–µ': 'O'
    };

    /* UI —ç–ª–µ–º–µ–Ω—Ç—ã */
    const csvFileInput = document.getElementById('csvFile');
    const templateFileInput = document.getElementById('templateFile');
    const outputNameInput = document.getElementById('outputName');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const currentMonthBtn = document.getElementById('currentMonth');
    const setDefaultsBtn = document.getElementById('setDefaults');
    const processBtn = document.getElementById('processBtn');
    const logEl = document.getElementById('log');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `${time}: ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç: —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü */
    function setCurrentMonth() {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      startDateInput.value = first.toISOString().slice(0, 10);
      endDateInput.value = last.toISOString().slice(0, 10);
    }

    /* –°–±—Ä–æ—Å –¥–∞—Ç */
    function resetDates() {
      startDateInput.value = '';
      endDateInput.value = '';
    }

    /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel (SheetJS) */
    function setCell(ws, cell, value) {
      ws[cell] = { t: (typeof value === 'number' ? 'n' : 's'), v: value };
    }

    /* –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ */
    processBtn.addEventListener('click', async () => {
      logEl.textContent = '';
      log('–ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏...');

      const csvFile = csvFileInput.files[0];
      const templateFile = templateFileInput.files[0];
      const outName = outputNameInput.value.trim() || '–ö–¶ –ê–≤–µ–Ω—é_–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.xlsx';

      if (!csvFile) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª!');
        return;
      }
      if (!templateFile) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ Excel —à–∞–±–ª–æ–Ω!');
        return;
      }
      if (!startDateInput.value || !endDateInput.value) {
        alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞!');
        return;
      }

      const startDate = dayjs(startDateInput.value, 'YYYY-MM-DD').startOf('day');
      const endDate = dayjs(endDateInput.value, 'YYYY-MM-DD').startOf('day');

      if (startDate.isAfter(endDate)) {
        alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è!');
        return;
      }

      log(`–ü–µ—Ä–∏–æ–¥: ${startDate.format('DD.MM.YYYY')} - ${endDate.format('DD.MM.YYYY')}`);

      // 1) –ü—Ä–æ—á–∏—Ç–∞—Ç—å CSV
      log('–ß—Ç–µ–Ω–∏–µ CSV...');
      const csvText = await readFileAsText(csvFile);
      const parsed = Papa.parse(csvText, {
        delimiter: ";",
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false
      });

      if (parsed.errors && parsed.errors.length) {
        log(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ CSV: ${parsed.errors.length}`);
        parsed.errors.slice(0, 5).forEach(e => log(`  ${e.message}`));
      }

      let records = parsed.data;
      log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${records.length} —Å—Ç—Ä–æ–∫ –∏–∑ CSV`);

      // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–æ–ª–æ–Ω–æ–∫
      const headers = parsed.meta.fields.map(h => h.replace(/\n/g, '').trim());
      // –ü—Ä–∏–≤—è–∑–∫–∞: —Å–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —á–∏—Å—Ç—ã–º–∏ –∫–ª—é—á–∞–º–∏
      records = records.map(row => {
        const nr = {};
        headers.forEach(h => nr[h] = (row[h] !== undefined ? row[h] : row[h]));
        return nr;
      });

      // 2) –ù–∞–π—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–∞–º–∏
      const dateCols = headers.filter(h => /–¥–∞—Ç–∞|date/i.test(h));
      log(`–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–∞–º–∏: ${dateCols.join(', ')}`);

      if (dateCols.length < 2) {
        log('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ >=2 –∫–æ–ª–æ–Ω–æ–∫ —Å –¥–∞—Ç–∞–º–∏. –û—Å—Ç–∞–Ω–æ–≤.');
        alert('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–∞–º–∏ (–æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 2). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CSV.');
        return;
      }

      const creationCol = dateCols[0];
      const changeCol = dateCols[1];

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç: –ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–æ–≤
      function parseDateVal(val) {
        if (val === undefined || val === null || String(val).trim() === '') return null;
        const s = String(val).trim();
        // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: DD.MM.YYYY, YYYY-MM-DD, DD/MM/YYYY, ISO
        const formats = ['DD.MM.YYYY', 'D.M.YYYY', 'YYYY-MM-DD', 'DD/MM/YYYY', 'YYYY/MM/DD', 'DD.MM.YY', 'YYYY-MM-DDTHH:mm:ss'];
        for (const f of formats) {
          const d = dayjs(s, f, true);
          if (d.isValid()) return d.startOf('day');
        }
        // fallback: try Date
        const d2 = dayjs(new Date(s));
        return d2.isValid() ? d2.startOf('day') : null;
      }

      // –î–æ–±–∞–≤–∏–º –∫–æ–ª–æ–Ω–∫–∏ _created_date –∏ _changed_date –∫–∞–∫ dayjs
      records.forEach(r => {
        r._created = parseDateVal(r[creationCol]);
        r._changed = parseDateVal(r[changeCol]);
      });

      // 3) –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel —à–∞–±–ª–æ–Ω
      log('–ß—Ç–µ–Ω–∏–µ Excel —à–∞–±–ª–æ–Ω–∞...');
      const templateArrayBuffer = await readFileAsArrayBuffer(templateFile);
      const workbook = XLSX.read(templateArrayBuffer, { type: 'array' });

      // 4) –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∞ –∏–∑ SHEET_CFG –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø–∏—Å–∏
      for (const sheetName of Object.keys(SHEET_CFG)) {
        log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–∏—Å—Ç: ${sheetName}`);

        // –í—ã–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
        let sheetRecords;
        if (sheetName === '–ü—Ä–æ—á–∏–π —Ç—Ä–∞—Ñ–∏–∫') {
          // –≤—Å–µ –∑–∞–ø–∏—Å–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ
          const allSourcesFlatten = Object.values(SHEET_CFG).flat();
          sheetRecords = records.filter(r => !allSourcesFlatten.includes(String(r['–ò—Å—Ç–æ—á–Ω–∏–∫'] || '').trim()));
        } else {
          const sources = SHEET_CFG[sheetName];
          sheetRecords = records.filter(r => sources.includes(String(r['–ò—Å—Ç–æ—á–Ω–∏–∫'] || '').trim()));
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º
        const groupA = sheetRecords.filter(r => r._created && r._changed
          && !r._created.isBefore(startDate) && !r._created.isAfter(endDate)
          && !r._changed.isBefore(startDate) && !r._changed.isAfter(endDate)
        );

        const groupB = sheetRecords.filter(r => r._created && r._changed
          && r._created.isBefore(startDate)
          && !r._changed.isBefore(startDate) && !r._changed.isAfter(endDate)
        );

        log(`  –ì—Ä—É–ø–ø–∞ A: ${groupA.length} –∑–∞–ø–∏—Å–µ–π`);
        log(`  –ì—Ä—É–ø–ø–∞ B: ${groupB.length} –∑–∞–ø–∏—Å–µ–π`);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–∏—Å—Ç –≤ —à–∞–±–ª–æ–Ω–µ
        if (!workbook.Sheets[sheetName]) {
          log(`  –í–Ω–∏–º–∞–Ω–∏–µ: –ª–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —à–∞–±–ª–æ–Ω–µ. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å –Ω–∞ —ç—Ç–æ—Ç –ª–∏—Å—Ç.`);
          continue;
        }
        const ws = workbook.Sheets[sheetName];

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏: row 3 –¥–ª—è A, row 9 –¥–ª—è B
        updateRowExcel(ws, groupA, 3, 'A');
        updateRowExcel(ws, groupB, 9, 'B');

        // –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ: row 15 = row3 + row9 –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ D..O (D=4..O=15)
        sumValuesOnSheet(ws, 3, 9, 15);
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å
      log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...');
      const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      triggerDownload(blob, outName);
      log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∞–π–ª "${outName}" –∑–∞–≥—Ä—É–∂–µ–Ω.`);
    });

    /* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç A{row} (total), B{row} (# bad), C{row} (qual), –∏ —Å—Ç–∞–¥–∏–∏ –ø–æ STAGE_MAPPING */
    function updateRowExcel(ws, data, rowNum, groupName) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º 11-–π —Å—Ç–æ–ª–±–µ—Ü –¥–∞–Ω–Ω—ã—Ö (–ø–æ –∏–Ω–¥–µ–∫—Å—É 10) ‚Äî —ç—Ç–æ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
      // –ü–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–º—è 11-–π –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –Ω–µ —Å—á–∏—Ç–∞—Ç—å –ø–ª–æ—Ö–∏–µ –ª–∏–¥—ã.
      let badLeadsCount = 0;
      if (data.length > 0) {
        const cols = Object.keys(data[0]);
        const reasonCol = cols[10] || null;
        if (reasonCol) {
          const reasons = data.map(r => (r[reasonCol] || '').toString().trim()).filter(x => x !== '');
          const badMask = reasons.filter(x => BAD_LEADS_REASONS.includes(x));
          badLeadsCount = badMask.length;
          // –õ–æ–≥
          //log(`    –ì—Ä—É–ø–ø–∞ ${groupName}: –Ω–∞–π–¥–µ–Ω–æ ${badLeadsCount} –ø–ª–æ—Ö–∏—Ö –ª–∏–¥–æ–≤ (–ø–æ –∫–æ–ª–æ–Ω–∫–µ "${reasonCol}")`);
        } else {
          //log(`    –ì—Ä—É–ø–ø–∞ ${groupName}: 11-–π —Å—Ç–æ–ª–±–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          badLeadsCount = 0;
        }
      } else {
        badLeadsCount = 0;
      }

      const total = data.length;
      const qual = total - badLeadsCount;

      setCell(ws, `B${rowNum}`, Number(badLeadsCount));
      setCell(ws, `A${rowNum}`, Number(total));
      setCell(ws, `C${rowNum}`, Number(qual));

      // –ü–æ–¥—Å—á—ë—Ç –ø–æ —Å—Ç–∞–¥–∏—è–º
      for (const stage in STAGE_MAPPING) {
        const colLetter = STAGE_MAPPING[stage]; // e.g. 'D'
        const count = data.filter(r => (r['–°—Ç–∞–¥–∏—è —Å–¥–µ–ª–∫–∏'] || '').toString().trim() === stage).length;
        setCell(ws, `${colLetter}${rowNum}`, Number(count));
      }
    }

    /* –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—è–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π: —Å–∫–ª–∞–¥—ã–≤–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏ –º–µ–∂–¥—É D..O (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ) –∏ –ø–∏—à–µ–º –≤ targetRow, —Ç–∞–∫–∂–µ –∫–æ–ª–æ–Ω–∫–∞ A */
    function sumValuesOnSheet(ws, rowA, rowB, targetRow) {
      // –∫–æ–ª–æ–Ω–∫–∏ D (4) .. O (15) -> letters D..O
      const letters = [];
      for (let i = 68; i <= 79; i++) { // ASCII D=68 ... O=79
        letters.push(String.fromCharCode(i));
      }

      for (const letter of letters) {
        const cellA = `${letter}${rowA}`;
        const cellB = `${letter}${rowB}`;
        const valA = getNumericCell(ws[cellA]);
        const valB = getNumericCell(ws[cellB]);
        setCell(ws, `${letter}${targetRow}`, Number(valA + valB));
      }

      // –ö–æ–ª–æ–Ω–∫–∞ A
      const aA = getNumericCell(ws[`A${rowA}`]);
      const aB = getNumericCell(ws[`A${rowB}`]);
      setCell(ws, `A${targetRow}`, Number(aA + aB));
    }

    /* –í–∑—è—Ç—å —á–∏—Å–ª–æ –∏–∑ –∫–ª–µ—Ç–∫–∏ ws[cell] –∏–ª–∏ 0 */
    function getNumericCell(cell) {
      if (!cell) return 0;
      if (typeof cell.v === 'number') return cell.v;
      const n = Number(cell.v);
      return isNaN(n) ? 0 : n;
    }

    /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ: —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ */
    function readFileAsText(file) {
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = () => rej(fr.error);
        fr.readAsText(file, 'utf-8');
      });
    }
    function readFileAsArrayBuffer(file) {
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = () => rej(fr.error);
        fr.readAsArrayBuffer(file);
      });
    }
    function triggerDownload(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI */
    currentMonthBtn.addEventListener('click', setCurrentMonth);
    setDefaultsBtn.addEventListener('click', resetDates);

    /* –£–¥–æ–±—Å—Ç–≤–æ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –¥–∞—Ç—ã ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü */
    window.addEventListener('load', () => {
      setCurrentMonth();
      log('–ì–æ—Ç–æ–≤–æ. –í—ã–±–µ—Ä–∏—Ç–µ CSV –∏ —à–∞–±–ª–æ–Ω, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É.');
    });
  </script>
</body>

</html>